<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unimate - Kiosk</title>
    <!-- Three.js is not used by default in this merged version, can be added if 3D map is re-integrated -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"
        integrity="sha512-dLxUelApnYxpLt6K2iomGngnHO83iUvZytA3YjDUCjT0HDOHKXnVYdf3hU4JjM8uEhxf9nD1/ey98U3t2vZ0qQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
    <style>
        /* Base styles from map_offline.html */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            color: #fff;
            background-color: #1a1a1a; /* Dark background */
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem; /* Reduced padding */
            background-color: #1a1a1a;
            border-bottom: 1px solid #333;
            position: relative;
            z-index: 1000;
        }

        header h1 {
            font-size: 1.5rem; /* Reduced font size */
            margin: 0;
        }

        .search-container {
            flex-grow: 1;
            max-width: 600px;
            margin: 0 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.5rem 1rem;
            border-radius: 50px;
            border: none;
            background-color: #333;
            color: #fff;
            padding-left: 2.5rem;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>');
            background-repeat: no-repeat;
            background-position: 0.75rem center;
        }
        
        .header-controls {
            display: flex;
            align-items: center;
        }

        .username-display {
            font-weight: 500;
            color: #ccc; /* Lighter color for username */
            margin-right: 1rem;
        }

        .action-button { /* Combined login/logout button style */
            background-color: #5473e8;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
        }
        .action-button:hover {
            background-color: #435ecc;
        }

        /* Main content area */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden; /* Prevent scrollbars on main container */
        }

        .sidebar {
            width: 300px;
            background-color: #1a1a1a;
            overflow-y: auto; /* Allow sidebar to scroll if content overflows */
            border-right: 1px solid #333;
            padding-bottom: 1rem; /* Space at the bottom of sidebar */
        }

        .sidebar-section {
            margin-bottom: 1rem;
        }

        .sidebar-section h2 {
            padding: 1rem;
            margin: 0;
            font-size: 1.2rem; /* Slightly larger section titles */
            border-bottom: 1px solid #333;
            color: #eee;
        }

        .event-list { /* Used for timetable and generic events */
            padding: 0;
        }

        .event-item { /* For individual events in sidebar */
            padding: 1rem;
            border-bottom: 1px solid #222;
            cursor: pointer;
            color: #ccc; /* Default text color for items */
        }
        .event-item:last-child {
            border-bottom: none;
        }

        .event-item:hover {
            background-color: #252525; /* Slightly darker hover */
        }

        .event-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
            color: #fff; /* Brighter title */
        }

        .event-meta { /* For time, organizer, course, room */
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 0.25rem;
        }
        .event-meta span, .event-meta div {
             display: block; /* Stack meta info */
             margin-bottom: 0.1rem;
        }

        .event-thumbnail {
            width: 60px; /* Slightly smaller thumbnail */
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            float: right;
            margin-left: 10px;
            border: 1px solid #333;
        }
        
        .event-type-badge {
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 0.5rem;
            display: inline-block;
        }
        .event-type-class { background-color: #2563eb; color: white; }
        .event-type-exam { background-color: #f97316; color: white; }
        .event-urgent-badge {
            background-color: #ef4444; color: white;
            padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.7rem;
            display: inline-block; margin-top: 0.3rem;
        }


        /* Map area from map_offline.html */
        #map-container-wrapper { /* New wrapper for the map to control its display */
            flex: 1;
            height: 100%;
            background-color: #222; /* Darker map background */
            overflow: hidden;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .offline-map {
            width: 90%;
            height: 90%;
            position: relative;
            background-image: 
                linear-gradient(rgba(40, 120, 40, 0.3) 1px, transparent 1px),
                linear-gradient(90deg, rgba(40, 120, 40, 0.3) 1px, transparent 1px),
                linear-gradient(rgba(40, 120, 40, 0.1) 0.5px, transparent 0.5px),
                linear-gradient(90deg, rgba(40, 120, 40, 0.1) 0.5px, transparent 0.5px);
            background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
            border: 2px solid #444;
        }
        
        .offline-map::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, transparent 50%, #222 100%);
            pointer-events: none;
        }
        
        .road { position: absolute; background-color: rgba(150, 150, 150, 0.7); transform: translate(-50%, -50%); }
        .highway-h { height: 15px; width: 70%; top: 50%; left: 50%; border-radius: 10px; }
        .highway-v { width: 15px; height: 70%; top: 50%; left: 30%; border-radius: 10px; }
        .road-1 { height: 8px; width: 40%; top: 30%; left: 60%; border-radius: 5px; }
        .road-2 { width: 8px; height: 30%; top: 60%; left: 70%; border-radius: 5px; }
        
        .map-marker {
            position: absolute; width: 20px; height: 20px;
            background-color: #5473e8; border-radius: 50%;
            transform: translate(-50%, -50%); border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); z-index: 10;
        }
        .map-marker.restaurant { background-color: #ff7700; }
        .map-marker.school { background-color: #8855ff; }
        .map-marker.park { background-color: #44bb44; }
        .park-area {
            position: absolute; width: 200px; height: 150px;
            background-color: rgba(40, 120, 40, 0.3); border-radius: 50%;
            top: 35%; left: 60%; transform: translate(-50%, -50%);
        }

        /* Login Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000; /* Ensure modal is on top */
        }

        .login-container { /* Re-styled for modal */
            background-color: #2a2a2a; /* Dark modal background */
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 24rem;
            color: #fff; /* Text color for modal */
        }

        .login-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .login-subtitle {
            text-align: center;
            color: #aaa; /* Lighter subtitle color */
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-input {
            display: block;
            width: 100%;
            padding: 0.75rem; /* Increased padding */
            border: 1px solid #444; /* Darker border */
            border-radius: 0.375rem;
            font-size: 0.875rem;
            box-sizing: border-box;
            background-color: #333; /* Dark input background */
            color: #fff; /* Light text color for input */
        }

        .form-input:focus {
            outline: none;
            border-color: #5473e8; /* Highlight color */
            box-shadow: 0 0 0 3px rgba(84, 115, 232, 0.3);
        }
        
        .modal-button { /* For buttons inside modal */
            display: block;
            width: 100%;
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            color: white;
            font-weight: 600;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
            text-align: center;
        }
        .modal-button-primary { background-color: #5473e8; }
        .modal-button-primary:hover { background-color: #435ecc; }
        .modal-button-secondary { background-color: #444; } /* Darker secondary button */
        .modal-button-secondary:hover { background-color: #555; }
        .modal-close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
        }


        .status-message {
            padding: 0.75rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            text-align: center;
        }
        .status-error { background-color: #7f1d1d; color: #fecaca; border: 1px solid #b91c1c;} /* Darker error */
        .status-success { background-color: #065f46; color: #d1fae5; border: 1px solid #047857;}

        .hidden { display: none !important; }

        /* Print styles adapted for dark theme */
        @media print {
            body { background-color: white !important; color: black !important; }
            header, .sidebar, .main-container { background-color: white !important; border-color: #ccc !important; }
            header h1, .sidebar-section h2, .event-title, .event-meta, .search-input, .username-display { color: black !important; }
            .search-input { background-color: #eee !important; }
            .event-item { border-color: #eee !important; background-color: white !important; }
            .event-item:hover { background-color: #f9f9f9 !important; }
            .action-button, #login-modal-overlay, #map-container-wrapper /* Hide map for printing timetable */ { display: none !important; }
            .sidebar { width: 100% !important; border-right: none !important; }
             .event-list { page-break-inside: auto; }
            .event-item { page-break-inside: avoid; }

        }
    </style>
</head>

<body>
    <header>
        <h1>Map</h1>
        <div class="search-container">
            <input type="text" class="search-input" placeholder="Find place">
        </div>
        <div class="header-controls">
            <span id="username-display" class="username-display hidden"></span>
            <button id="main-login-button" class="action-button">Log in</button>
        </div>
    </header>

    <div class="main-container">
        <aside class="sidebar">
            <!-- This section will be dynamically populated with Timetable or generic Events -->
            <section id="timetable-section" class="sidebar-section">
                <h2 id="sidebar-title">Events</h2>
                <div id="event-list-content" class="event-list">
                    <!-- Placeholder for events/timetable -->
                    <div class="event-item">
                        <img src="https://via.placeholder.com/60" alt="Event thumbnail" class="event-thumbnail">
                        <div class="event-title">Placeholder Event 1</div>
                        <div class="event-meta">
                            <span class="event-time">10:00 AM - 11:00 AM</span>
                            <span class="event-organizer">By Campus Activities</span>
                        </div>
                    </div>
                    <div class="event-item">
                         <img src="https://via.placeholder.com/60" alt="Event thumbnail" class="event-thumbnail">
                        <div class="event-title">Placeholder News Item</div>
                        <div class="event-meta">
                            <span class="event-time">2 hours ago</span>
                            <span class="event-organizer">By University News</span>
                        </div>
                    </div>
                </div>
            </section>
             <section id="actions-section" class="sidebar-section hidden">
                <h2 style="margin-top:1rem;">Actions</h2>
                <div class="event-list">
                     <div class="event-item" id="print-button-container" style="padding:0;">
                        <button id="print-timetable-button" class="modal-button modal-button-secondary" style="width: calc(100% - 2rem); margin: 1rem;">üñ®Ô∏è Print Timetable</button>
                    </div>
                     <div class="event-item" id="refresh-button-container" style="padding:0;">
                        <button id="refresh-data-button" class="modal-button modal-button-secondary" style="width: calc(100% - 2rem); margin: 1rem;">üîÑ Refresh Data</button>
                    </div>
                </div>
            </section>
        </aside>

        <div id="map-container-wrapper">
            <div class="offline-map">
                <div class="road highway-h"></div>
                <div class="road highway-v"></div>
                <div class="road road-1"></div>
                <div class="road road-2"></div>
                <div class="park-area"></div>
                <div class="map-marker" style="top: 40%; left: 50%;" title="University Hub"></div>
                <div class="map-marker restaurant" style="top: 35%; left: 48%;" title="Cafeteria"></div>
                <div class="map-marker school" style="top: 45%; left: 45%;" title="Library"></div>
                <div class="map-marker park" style="top: 38%; left: 55%;" title="Campus Green"></div>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal-overlay" class="modal-overlay hidden">
        <div class="login-container">
            <button id="close-login-modal-button" class="modal-close-button">&times;</button>
            <h1 class="login-title">Unimate Login</h1>
            <p class="login-subtitle">Tap your ID card or login with credentials</p>
            <div id="login-status" class="status-message hidden"></div>
            <form id="login-form">
                <div class="form-group">
                    <input type="text" id="username" class="form-input" placeholder="Username" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" class="form-input" placeholder="Password" required>
                </div>
                <button type="submit" class="modal-button modal-button-primary">Login</button>
            </form>
            <button id="demo-mode-btn" class="modal-button modal-button-secondary" style="margin-top: 0.5rem;">
                Try Demo Mode
            </button>
        </div>
    </div>

    <script>
        // Global variables
        let isConnectedMode = false;
        let authToken = null;
        let currentUsername = '';
        // const mapScene, mapCamera, mapRenderer, currentRoute are not used for the offline map by default.
        // They can be re-introduced if 3D map functionality is added back.

        // DOM Elements
        const mainLoginButton = document.getElementById('main-login-button');
        const loginModalOverlay = document.getElementById('login-modal-overlay');
        const closeLoginModalButton = document.getElementById('close-login-modal-button');
        const loginForm = document.getElementById('login-form');
        const demoModeButton = document.getElementById('demo-mode-btn');
        const usernameDisplay = document.getElementById('username-display');
        const loginStatusEl = document.getElementById('login-status');
        const eventListContent = document.getElementById('event-list-content');
        const sidebarTitle = document.getElementById('sidebar-title');
        const actionsSection = document.getElementById('actions-section');
        const printTimetableButton = document.getElementById('print-timetable-button');
        const refreshDataButton = document.getElementById('refresh-data-button');


        // Sample demo event data (adapted for new display)
        const demoEvents = [
            {
                id: 1, title: "ENGGEN705 Project Mtg", event_type: "class",
                course: { code: "ENGGEN705", name: "Final Year Project" }, room: { building: "ENG", number: "Design Studio 1" },
                start_time: new Date(Date.now() + 3600000).toISOString(), end_time: new Date(Date.now() + 7200000).toISOString(),
                lecturer: "Dr. Project Lead", is_urgent: false, thumbnail: "https://via.placeholder.com/60/5473e8/fff?text=P"
            },
            {
                id: 2, title: "Guest Lecture: AI Ethics", event_type: "event", // Changed to generic event
                course: { code: "COMP invitado", name: "Special Event" }, room: { building: "OGGB", number: "Lecture Theatre 4" },
                start_time: new Date(Date.now() + 86400000).toISOString(), end_time: new Date(Date.now() + 86400000 + 5400000).toISOString(),
                lecturer: "Prof. Ethica", is_urgent: true, thumbnail: "https://via.placeholder.com/60/ef4444/fff?text=A"
            },
            {
                id: 3, title: "Library Study Session", event_type: "class",
                course: { code: "SELFSTUDY", name: "Quiet Study" }, room: { building: "LIB", number: "Floor 3 Quiet Zone" },
                start_time: new Date(Date.now() + 2 * 3600000).toISOString(), end_time: new Date(Date.now() + 2 * 3600000 + 7200000).toISOString(),
                lecturer: "N/A", is_urgent: false, thumbnail: "https://via.placeholder.com/60/34d399/fff?text=S"
            }
        ];
        
        const genericEvents = [
             {
                id: 101, title: "Campus Coffee Morning", event_type: "event",
                course: { code: "SOCIAL", name: "Community Event" }, room: { building: "Student Hub", number: "Cafe" },
                start_time: new Date(Date.now() + 4 * 3600000).toISOString(), end_time: new Date(Date.now() + 4 * 3600000 + 3600000).toISOString(),
                lecturer: "Student Association", is_urgent: false, thumbnail: "https://via.placeholder.com/60/f59e0b/fff?text=C"
            },
            {
                id: 102, title: "University Art Exhibition", event_type: "event",
                course: { code: "ARTS", name: "Cultural Event" }, room: { building: "Fine Arts", number: "Gallery" },
                start_time: new Date(Date.now() + 1.5 * 86400000).toISOString(), end_time: new Date(Date.now() + 1.5 * 86400000 + 10800000).toISOString(),
                lecturer: "Arts Department", is_urgent: false, thumbnail: "https://via.placeholder.com/60/8b5cf6/fff?text=E"
            }
        ];


        // --- Event Handlers ---
        mainLoginButton.addEventListener('click', () => {
            if (authToken) { // If logged in, this button is "Logout"
                logout();
            } else { // If not logged in, this button is "Log in"
                loginModalOverlay.classList.remove('hidden');
            }
        });

        closeLoginModalButton.addEventListener('click', () => {
            loginModalOverlay.classList.add('hidden');
            hideStatus();
        });

        loginModalOverlay.addEventListener('click', (e) => { // Close if clicked outside modal content
            if (e.target === loginModalOverlay) {
                loginModalOverlay.classList.add('hidden');
                hideStatus();
            }
        });

        loginForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            try {
                showStatus('Logging in...', false, true); // true for modal status
                // **MOCK API CALL FOR NOW**
                // const response = await fetch('/api/login/', { /* ... */ });
                // Simulate API delay and response
                await new Promise(resolve => setTimeout(resolve, 1000));

                if (username === "test" && password === "test") {
                    const fakeData = { access: "fake_jwt_token_12345", user: { username: username, events: demoEvents } };
                    handleLoginSuccess(fakeData, username);
                } else if (username === "user" && password === "pass") {
                     const altEvents = [
                        { id: 4, title: "Physics Lab Practical", event_type: "class", course: { code: "PHY101", name: "Physics I" }, room: { building: "SCI", number: "Lab 3B" }, start_time: new Date().toISOString(), end_time: new Date(Date.now() + 7200000).toISOString(), lecturer: "Dr. Quark", is_urgent: true, thumbnail: "https://via.placeholder.com/60/ec4899/fff?text=P" }
                     ];
                    const fakeData = { access: "another_fake_token", user: { username: username, events: altEvents } };
                    handleLoginSuccess(fakeData, username);
                }
                else {
                    throw new Error('Invalid credentials');
                }
            } catch (error) {
                console.error('Login error:', error);
                showStatus('Login failed: ' + error.message, true, true); // true for modal status, true for error
            }
        });

        demoModeButton.addEventListener('click', () => {
            isConnectedMode = false;
            currentUsername = 'Demo User';
            authToken = null; // No token in demo mode
            localStorage.removeItem('unimate_token');
            localStorage.removeItem('unimate_username');
            
            showStatus('Demo Mode Activated!', false, true);
            setTimeout(() => {
                loginModalOverlay.classList.add('hidden');
                hideStatus(); // Hide status after a delay
                updateHeaderUI(true); // Update header for demo user
                renderSidebarContent(demoEvents, "Your Demo Timetable");
                actionsSection.classList.remove('hidden');
            }, 1000);
        });
        
        printTimetableButton.addEventListener('click', () => window.print());
        refreshDataButton.addEventListener('click', () => {
            if (isConnectedMode && authToken) {
                fetchEvents();
            } else if (!isConnectedMode && currentUsername === 'Demo User'){
                 showStatus('Displaying demo data.', false);
                 renderSidebarContent(demoEvents, "Your Demo Timetable");
            } else {
                 showStatus('Not logged in. Displaying generic events.', true);
                 renderSidebarContent(genericEvents, "Upcoming Events");
            }
        });

        // --- UI Update Functions ---
        function updateHeaderUI(loggedIn, username = '') {
            if (loggedIn) {
                usernameDisplay.textContent = username || currentUsername;
                usernameDisplay.classList.remove('hidden');
                mainLoginButton.textContent = 'Log out';
            } else {
                usernameDisplay.classList.add('hidden');
                mainLoginButton.textContent = 'Log in';
            }
        }

        function handleLoginSuccess(data, username) {
            authToken = data.access;
            currentUsername = username; // Use the username from param, not data.user.username for mock
            isConnectedMode = true;

            localStorage.setItem('unimate_token', authToken);
            localStorage.setItem('unimate_username', currentUsername);

            showStatus('Login successful!', false, true); // Modal status
            setTimeout(() => {
                loginModalOverlay.classList.add('hidden');
                hideStatus();
                updateHeaderUI(true);
                fetchEvents(); // Fetch real events or use data.user.events if provided
                actionsSection.classList.remove('hidden');
            }, 1000);
        }
        
        function logout() {
            authToken = null;
            currentUsername = '';
            isConnectedMode = false;
            localStorage.removeItem('unimate_token');
            localStorage.removeItem('unimate_username');
            
            updateHeaderUI(false);
            renderSidebarContent(genericEvents, "Upcoming Events"); // Show generic events after logout
            actionsSection.classList.add('hidden');
            // Optionally, clear form fields if needed, but modal is usually closed
        }

        function showStatus(message, isError = false, isModal = false) {
            const el = isModal ? loginStatusEl : document.getElementById('global-status'); // Assuming a global status el if not modal
            if (el) {
                el.textContent = message;
                el.className = isError ? 'status-message status-error' : 'status-message status-success';
                el.classList.remove('hidden');
            }
        }

        function hideStatus(isModal = false) {
            const el = isModal ? loginStatusEl : document.getElementById('global-status');
            if (el) el.classList.add('hidden');
        }
        
        // --- Data Handling and Rendering ---
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            const options = { weekday: 'short', month: 'short', day: 'numeric' };
            try {
                return new Date(dateStr).toLocaleDateString(undefined, options);
            } catch (e) { return 'Invalid Date'; }
        }

        function formatTime(dateStr) {
            if (!dateStr) return '';
            const options = { hour: '2-digit', minute: '2-digit', hour12: true };
             try {
                return new Date(dateStr).toLocaleTimeString(undefined, options);
            } catch (e) { return 'Invalid Time'; }
        }

        async function fetchEvents() {
            if (!authToken) {
                console.warn('No auth token. Cannot fetch events.');
                showStatus('Authentication required to fetch events.', true);
                renderSidebarContent(genericEvents, "Upcoming Events"); // Fallback to generic if not authenticated
                return;
            }
            showStatus('Fetching your events...', false);
            try {
                // const response = await fetch('/api/events/', { headers: { 'Authorization': `Bearer ${authToken}` } });
                // if (!response.ok) throw new Error(`API Error: ${response.status}`);
                // const events = await response.json();
                
                // MOCK API call
                await new Promise(resolve => setTimeout(resolve, 1000));
                const events = currentUsername === "test" ? demoEvents : [ // Simulate different events for different users
                    { id: 4, title: "Advanced Algo Lecture", event_type: "class", course: { code: "CS301", name: "Algorithms" }, room: { building: "COMP", number: "LT101" }, start_time: new Date(Date.now() + 2*3600000).toISOString(), end_time: new Date(Date.now() + 9200000).toISOString(), lecturer: "Prof. Dijkstra", is_urgent: false, thumbnail: "https://via.placeholder.com/60/10b981/fff?text=A" },
                    { id: 5, title: "Mid-Semester Exam: CS301", event_type: "exam", course: { code: "CS301", name: "Algorithms" }, room: { building: "EXAMHALL", number: "Hall A" }, start_time: new Date(Date.now() + 3 * 86400000).toISOString(), end_time: new Date(Date.now() + 3 * 86400000 + 7200000).toISOString(), lecturer: "N/A", is_urgent: true, thumbnail: "https://via.placeholder.com/60/ef4444/fff?text=E" }
                ];

                renderSidebarContent(events, "Your Timetable");
                hideStatus();
            } catch (error) {
                console.error('Error fetching events:', error);
                showStatus(`Error fetching events: ${error.message}`, true);
                renderSidebarContent(demoEvents, "Your Timetable (Demo Fallback)"); // Fallback to demo on error
            }
        }

        function renderSidebarContent(events, title = "Events") {
            sidebarTitle.textContent = title;
            eventListContent.innerHTML = ''; // Clear previous events

            if (!events || events.length === 0) {
                eventListContent.innerHTML = '<div class="event-item" style="text-align:center; color:#888;">No events to display.</div>';
                return;
            }

            const sortedEvents = [...events].sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

            sortedEvents.forEach((event, index) => {
                const eventElement = document.createElement('div');
                eventElement.className = 'event-item';
                
                const thumb = event.thumbnail || `https://via.placeholder.com/60/${event.event_type === 'exam' ? 'ef4444' : '5473e8'}/fff?text=${(event.course?.code || 'E').substring(0,1)}`;

                let eventTypeLabel = event.event_type || 'event';
                let eventTypeClass = `event-type-${eventTypeLabel.toLowerCase()}`;
                 if (eventTypeLabel.toLowerCase() !== 'class' && eventTypeLabel.toLowerCase() !== 'exam') {
                    eventTypeClass = 'event-type-generic'; // Fallback style for other event types
                 }


                eventElement.innerHTML = `
                    <img src="${thumb}" alt="Thumb" class="event-thumbnail">
                    <div class="event-title">
                        ${currentUsername && isConnectedMode ? (index + 1) + '. ' : ''}${event.title || 'Untitled Event'}
                        <span class="event-type-badge ${eventTypeClass}">${eventTypeLabel.toUpperCase()}</span>
                    </div>
                    <div class="event-meta">
                        <span>Course: ${event.course?.code || 'N/A'} - ${event.course?.name || 'N/A'}</span>
                        <span>Location: ${event.room?.building || ''} ${event.room?.number || 'TBA'}</span>
                        <span>Time: ${formatDate(event.start_time)} &bull; ${formatTime(event.start_time)} - ${formatTime(event.end_time)}</span>
                        ${event.lecturer ? `<span>Lecturer: ${event.lecturer}</span>` : ''}
                    </div>
                    ${event.is_urgent ? '<div class="event-urgent-badge">Urgent</div>' : ''}
                `;
                eventElement.addEventListener('click', () => {
                    // Placeholder for event click action (e.g., show details on map, or modal)
                    alert(`Event: ${event.title}\nLocation: ${event.room?.building} ${event.room?.number}`);
                });
                eventListContent.appendChild(eventElement);
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function () {
            console.log("Unimate Kiosk UI Initialized");
            const storedToken = localStorage.getItem('unimate_token');
            const storedUsername = localStorage.getItem('unimate_username');

            if (storedToken && storedUsername) {
                authToken = storedToken;
                currentUsername = storedUsername;
                isConnectedMode = true;
                updateHeaderUI(true);
                fetchEvents(); // Fetch events for logged-in user
                actionsSection.classList.remove('hidden');
            } else {
                updateHeaderUI(false);
                renderSidebarContent(genericEvents, "Upcoming Events"); // Show generic events if not logged in
                actionsSection.classList.add('hidden');
            }
            // Three.js map initialization (initMap()) would go here if re-enabled.
            // For now, the offline map is purely CSS/HTML.
        });

    </script>
</body>
</html>